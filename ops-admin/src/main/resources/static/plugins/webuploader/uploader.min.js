!function($,window,document){var FileUploader=function(ele,opt){this.$element=ele,this.defaults={server:"",deleteServer:"",md5Server:"",pick:"#picker",resize:false,prepareNextFile:true,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/png,image/jpeg,image/gif,image/bmp"},fileNumLimit:10,duplicate:false,fileSingleSizeLimit:10*1024*1024,dnd:".layui-upload",disableGlobalDnd:true,paste:document.body,threads:3,isRealTimeDelete:true,eventAddFileErrorCustom:false,addFileError:function(){},fileDeleted:function(){},beforeFileQueued:function(){},fileQueued:function(){},uploadProgress:function(){},uploadSuccess:function(){},uploadError:function(){},uploadFinished:function(){},picData:[],picServerPrefix:"",hidePicker:true,},this.options=$.extend({},this.defaults,opt)};FileUploader.prototype={init:function(){var that=this;that.$element.addClass("layui-hide").after('<div id="layui-upload" class="layui-upload" title="点击选择文件">					<span class="center-ps ps"><i class="la la-picture-o" style="display: block;color: #ddd;font-size: 86px;"></i>可以尝试<g style="color:red">拖拽</g>图片或者使用<g style="color:red">截屏工具粘贴</g>(Ctrl+V)图片到本区域</span>					<div id="listView" class="layui-upload-list">					</div>					<div id="uploader" class="wu-example">						<div class="btns">						    <div id="picker">添加图片</div>						</div>					</div>				</div>			');var uploader=WebUploader.create(this.options);that.uploader=uploader;that.$uploader="#layui-upload";that.$listView=$("#listView");layui.use(["layer","element"],function(){that.layer=layui.layer;that.element=layui.element;that.initevents();that.reloadPics(that.options.picData)});if(that.options.hidePicker){$("#picker").css("display","none");var label="#picker label";$("#layui-upload").on("click",function(e){if(e.target!=this){return}$(label).click()});that.$listView.on("click",function(e){if(e.target!=this){return}$(label).click()});$(".center-ps").on("click",function(){$(label).click()})}return that},upload:function(){this.uploader.upload()},data:{uploadedFiles:{},deletedFileIds:[],},errorMsg:function(content){return this.layer.msg(content,{icon:2,shift:6,time:2000})},removeFile:function(item,file){item.find(".image-reload,.image-delete,.upload-img-prev-link").off().end().remove();this.uploader.removeFile(file,true);delete this.data.uploadedFiles[file.id];if(this.$listView.find(".layui-upload-item").length<=0){$(this.$uploader).find(".center-ps").removeClass("layui-hide")}},initevents:function(){this.ready();this.addFileError();this.beforeFileQueued();this.fileQueued();this.uploadProgress();this.uploadSuccess();this.uploadError();this.uploadFinished()},ready:function(){this.uploader.on("ready",function(){console.log("ready")})},addFileError:function(){var that=this;that.uploader.on("error",function(type,arg1,arg2){if(that.options.eventAddFileErrorCustom){typeof that.options.addFileError=="function"&&that.options.addFileError(type,arg1,arg2)}else{if(type==="Q_TYPE_DENIED"){that.errorMsg('文件类型不符，请选择正确的图片:<span style="color:red">'+arg1.name+"</span>")}else{if(type==="Q_EXCEED_NUM_LIMIT"){that.errorMsg('超出数量限制，最大上传数量为：<span style="color:red">'+arg1+"</span>")}else{if(type==="F_DUPLICATE"){that.errorMsg('这个文件已经被选择了:<span style="color:red">'+arg1.name+"</span>")}}}}})},beforeFileQueued:function(){var that=this;that.uploader.on("beforeFileQueued",function(file){if(file.size>that.options.fileSingleSizeLimit){that.errorMsg("最大允许上传大小为"+that.options.fileSingleSizeLimit/1024/1024+"M");return false}var size=$(".layui-upload-item").length;if(size>=that.options.fileNumLimit){that.errorMsg('超出数量限制，最大上传数量为：<span style="color:red">'+that.options.fileNumLimit+"</span>");return false}return typeof that.options.beforeFileQueued=="function"&&that.options.beforeFileQueued(file)})},addFile:function(file){var that=this;$(this.$uploader).find(".center-ps").addClass("layui-hide");var dataid=file.dataid||"";var $item=$(['<div id="'+file.id+'" dataid="'+dataid+'" class="layui-upload-item upload-img-prev-link" title="'+file.name+'">','<div class="layui-upload-hover-item layui-upload-preview"></div>','<div class="layui-upload-btns layui-upload-hover-item">','<a href="javascript:;" class="layui-btn layui-btn-mini image-reload layui-hide" title="重传"><i class="fa fa-repeat"></i></a>','<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-danger image-delete" title="删除"><i class="fa fa-trash"></i></a>',"</div>",'<div class="layui-progress layui-progress-big layui-progress-radius-fix" lay-showpercent="true" lay-filter="image'+file.id+'">','<span class="layui-progress-text size">'+(file.size/1024).toFixed(1)+"kb</span>",'<div class="layui-progress-bar" lay-percent="0%">','<span class="layui-progress-text progress-text">0%</span>',"</div>",'<div class="layui-progress-status">等待上传</div>',"</div>","</div>"].join(""));var imgsrc;var reader=new FileReader();reader.readAsDataURL(file.source.source);reader.onload=function(data){if(this.result){var result=this.result;var $img=$('<img style="width:233px;height:200px" src="'+result+'"></img>');
$item.find(".layui-upload-preview").append($img);$img.on("click",function(){that.layer.photos({photos:{data:[{alt:file.name,src:result,pid:file.id}]},anim:5})})}else{img="<span>不能预览</span>"}};$item.find(".image-delete").on("click",function(){var $this=$(this);if(that.data.uploadedFiles[file.id]){var index=that.layer.alert("该文件已上传，确认删除附件吗？",{skin:"",title:"提示信息",closeBtn:1},function(){var id=$this.closest(".layui-upload-item").attr("dataid");if(that.options.isRealTimeDelete){$.ajax({url:settings.deleteServer,data:{id:id},success:function(data){if(data.success){that.removeFile($item,file)}that.layer.msg((data&&data.message)||"未知")}})}else{that.removeFile($item,file)}that.data.deletedFileIds.push(id);that.layer.close(index);typeof that.options.fileDeleted=="function"&&that.options.fileDeleted(that.data)})}else{that.removeFile($item,file)}});$item.find(".image-reload").on("click",function(){that.uploader.upload(file)});that.$listView.append($item)},fileQueued:function(){var that=this;that.uploader.on("fileQueued",function(file){typeof that.options.fileQueued=="function"&&that.options.fileQueued(file);that.addFile(file)})},uploadProgress:function(){var that=this;that.uploader.on("uploadProgress",function(file,percentage){typeof that.options.uploadProgress=="function"&&that.options.uploadProgress(file,percentage.toFixed(1)*100);var $item=$("#"+file.id);$item.find(".layui-progress-status").html("上传中...");that.element.progress("image"+file.id,percentage.toFixed(1)*100+"%")})},successFile:function(file,data){var $item=$("#"+file.id);$item.attr("dataid",data.data.id||"");if(data.success){$item.find(".layui-progress-status").html("上传成功");$item.find(".layui-progress-bar").css("background-color","#86EAA1");this.data.uploadedFiles[file.id]=data.data}else{this.errorFile(file,data)}},errorFile:function(file,data){var $item=$("#"+file.id);$item.find(".layui-progress-status").html("上传失败");$item.find(".layui-progress-bar").css("background-color","#ff5722");$item.find(".image-reload").removeClass("layui-hide");this.errorMsg(file.id+"上传失败："+data.message)},uploadSuccess:function(){var that=this;that.uploader.on("uploadSuccess",function(file,response){typeof that.options.uploadSuccess=="function"&&that.options.uploadSuccess(file,response);that.successFile(file,response)})},uploadError:function(){var that=this;that.uploader.on("uploadError",function(file){typeof that.options.uploadError=="function"&&that.options.uploadError(file);that.error(file)})},uploadFinished:function(){var that=this;that.uploader.on("uploadFinished",function(){var length=$("#listView").children().length;if(Object.keys(that.data.uploadedFiles).length==length){typeof that.options.uploadFinished=="function"&&that.options.uploadFinished(that.data)}})},reloadPics:function(picData){var that=this;var getFileBlob=function(url,cb){var xhr=new XMLHttpRequest();var _true=xhr.open("GET",(url.startsWith("http://")||url.startsWith("https://"))?url:that.options.picServerPrefix+url);xhr.responseType="blob";xhr.addEventListener("load",function(){cb(xhr.response)});xhr.send()};var blobToFile=function(blob,name){blob.lastModifiedDate=new Date();blob.name=name;return blob};var getFileObject=function(filePathOrUrl,cb){getFileBlob(filePathOrUrl,function(blob){cb(blobToFile(blob,filePathOrUrl.substring(filePathOrUrl.lastIndexOf("/")+1,filePathOrUrl.length)))})};$.each(picData,function(index,item){getFileObject(item.url,function(fileObject){var wuFile=new WebUploader.Lib.File(WebUploader.guid("rt_"),fileObject);var file=new WebUploader.File(wuFile);file.statusText="complete";file.dataid=item.id;that.addFile(file);var data={success:true,data:item};that.successFile(file,data);that.element.progress("image"+file.id,"100%")})})}};$.fn.uploader=function(options){var fileUploader=new FileUploader(this,options);return fileUploader.init()}}(jQuery,window,document);